<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard – {{ user.username }}</title>

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script>htmx.config.showError = false;</script>
  <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/json-enc.js"></script>

  <link rel="stylesheet" href="/static/style.css">

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Send API key with every htmx request
      htmx.defineExtension("api-key", {
        onEvent: (name, evt) => {
          if (name === "htmx:configRequest") {
            evt.detail.headers["api_key"] = "{{ api_key }}";
          }
        }
      });

      // Ensure result box is empty initially
      const result = document.getElementById("result");
      if (result) result.innerHTML = "";
    });
  </script>
</head>

<body hx-ext="api-key">
  <div class="container">

    <h1>Welcome, {{ user.username }}</h1>
    <p>Credits: <strong id="credits">{{ user.credits }}</strong></p>
    <a href="/">Logout / Switch user</a>
    <hr>

    <!-- COMMAND FORM -->
    <form hx-post="/api/commands"
          hx-target="#result"
          hx-swap="innerHTML"
          hx-on::after-request="
              this.reset();
              htmx.ajax('GET','/api/me',{target:'#credits',swap:'innerHTML'});
          ">

      <input name="command_text"
             placeholder="Try: ls, pwd, whoami, rm -rf /"
             required autocomplete="off"
             style="width:650px;padding:13px;font-size:17px;">

      <button type="submit" style="padding:13px 28px;font-size:17px;">Execute</button>
    </form>

    <!-- RESULT BOX (initially empty) -->
    <div id="result" style="margin:30px 0; min-height:80px;"></div>

    <h2>Command History</h2>

    <table border="1" width="100%" style="border-collapse:collapse;">
      <thead style="background:#0066ff;color:white;">
        <tr>
          <th>ID</th>
          <th>Command</th>
          <th>Status</th>
          <th>Result</th>
          <th>Time</th>
        </tr>
      </thead>

      <tbody id="history"
             hx-get="/api/commands"
             hx-trigger="load delay:500ms, every 3s"
             hx-swap="innerHTML">
        Loading…
      </tbody>
    </table>
  </div>

  <script>
    // Render EXECUTED/BLOCKED box ONLY for real commands (not on page load)
    htmx.on("htmx:afterRequest", function(evt) {
      if (!evt.detail.xhr.responseURL.endsWith("/api/commands")) return;

      let data;
      try { data = JSON.parse(evt.detail.xhr.response); }
      catch { return; }

      // ⛔ Skip rendering when page loads or when no command_text in response
      if (!data.command_text) return;

      const success = data.status === "executed";

      document.getElementById("result").innerHTML = `
        <div style="padding:25px; border-radius:12px;
                    background:${success ? '#d4edda' : '#f8d7da'};
                    border-left:8px solid ${success ? 'green' : 'red'};
                    font-family:monospace; font-size:16px;">

          <strong>> ${data.command_text}</strong><br><br>

          <span style="font-size:28px; font-weight:bold; color:${success ? 'green' : 'red'}">
            ${success ? 'EXECUTED' : 'BLOCKED'}
          </span><br><br>

          ${success ? data.result : 'Command blocked by security rule'}<br><br>

          <small>Credits left: <strong>${data.new_balance}</strong></small>
        </div>`;
    });

    // Render history table
    htmx.on("htmx:afterOnLoad", function(evt) {
      if (evt.detail.target.id !== "history") return;

      let cmds;
      try { cmds = JSON.parse(evt.detail.xhr.response); }
      catch(e) { cmds = []; }

      if (!Array.isArray(cmds) || cmds.length === 0) {
        evt.detail.target.innerHTML =
          "<tr><td colspan='5' style='text-align:center;color:#666'>No commands yet</td></tr>";
        return;
      }

      const rows = cmds.map(c => `
        <tr style="text-align:left;">
          <td>${c.id}</td>
          <td><code>${c.command_text.replace(/</g,'&lt;')}</code></td>
          <td><strong style="color:${c.status==='executed'?'green':'red'}">
            ${c.status.toUpperCase()}
          </strong></td>
          <td>${c.result || '-'}</td>
          <td>${new Date(c.created_at).toLocaleString()}</td>
        </tr>
      `).join('');

      evt.detail.target.innerHTML = rows;
    });
  </script>

</body>
</html>
